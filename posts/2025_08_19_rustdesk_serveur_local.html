<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RustDesk self‑hosté : déployer un serveur local (hbbs + hbbr)</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    .wrap{max-width:820px;margin:auto;padding:2rem}
    article{background:var(--card-bg);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:1.2rem 1.4rem}
    h1{margin-top:0}
    .meta{opacity:.8;margin:.4rem 0 1rem}
    pre,code{white-space:pre-wrap}
    img{max-width:100%;display:block;margin:1rem auto}
    .tip{border-left:4px solid #2ecc71;padding:.75rem 1rem;background:rgba(46,204,113,.08);border-radius:8px;margin:1rem 0}
    .warn{border-left:4px solid #e67e22;padding:.75rem 1rem;background:rgba(230,126,34,.08);border-radius:8px;margin:1rem 0}
    .danger{border-left:4px solid #e74c3c;padding:.75rem 1rem;background:rgba(231,76,60,.08);border-radius:8px;margin:1rem 0}
    .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <main class="wrap">
    <article>
      <h1>RustDesk self‑hosté : déployer un serveur local (hbbs + hbbr)</h1>
      <div class="meta">19 août 2025 • Remote • Réseau • Sécurité</div>

      <p><strong>Objectif</strong> : héberger soi‑même RustDesk pour que toutes les connexions passent par <em>votre</em> infrastructure, sans dépendre du cloud public. Idéal pour la confidentialité, la conformité et les faibles latences en LAN.</p>

      <h2>Pourquoi un serveur <em>local</em> ?</h2>
      <ul>
        <li><strong>Confidentialité & contrôle</strong> : clés et métadonnées restent on‑prem (flux chiffré E2E).</li>
        <li><strong>Moins de latence</strong> : trafic local entre postes du même site.</li>
        <li><strong>Résilience</strong> : accès à vos machines même sans Internet (intranet).</li>
        <li><strong>Conformité</strong> : localisation des données (RGPD) et politique sécurité de l’entreprise.</li>
        <li><strong>Coût</strong> : édition communautaire open‑source (AGPL), pas d’abonnement.</li>
      </ul>
      <h2>RustDesk, c’est quoi ? À quoi ça sert ?</h2>
      <p><strong>RustDesk</strong> est un logiciel de prise en main à distance <em>open‑source</em> (AGPL) et multi‑plateforme (Windows, macOS, Linux, Android, iOS). C’est une alternative à TeamViewer/AnyDesk qui peut fonctionner soit via le réseau public par défaut, soit en mode <em>self‑host</em> avec votre propre serveur (hbbs + hbbr).</p>
      <ul>
        <li><strong>Accès à distance sécurisé</strong> : chiffrement de bout en bout, mot de passe d’accès sans surveillance.</li>
        <li><strong>Fonctionnalités essentielles</strong> : partage d’écran, clavier/souris, transfert de fichiers, presse‑papiers, chat.</li>
        <li><strong>Traverse les NAT/pare‑feu</strong> : connexion directe P2P si possible, sinon relais via hbbr.</li>
        <li><strong>Déploiement simple</strong> : binaire portable/installer, packages pour NAS/VM, et images Docker pour le serveur.</li>
      </ul>

      <h3>Pourquoi l’héberger en local ?</h3>
      <ul>
        <li><strong>Confidentialité & contrôle</strong> : vos métadonnées restent on‑prem et vous maîtrisez la clé serveur.</li>
        <li><strong>Latence réduite</strong> : connexions plus courtes pour les postes du même site.</li>
        <li><strong>Résilience</strong> : accès en intranet même en cas de coupure Internet.</li>
        <li><strong>Conformité</strong> : localisation des données (RGPD) et politique sécurité interne.</li>
        <li><strong>Coût</strong> : l’édition communautaire est gratuite ; l’édition Pro ajoute des fonctions d’admin centralisée (optionnelle).</li>
      </ul>

      <h2>Architecture en 2 briques</h2>
      <div class="grid">
        <div>
          <h3>hbbs (ID / rendezvous)</h3>
          <ul>
            <li>Attribue les <strong>ID</strong> et négocie la session (découverte NAT).</li>
            <li>Ports : <code>21115/tcp</code> (ID), <code>21116/tcp+udp</code> (handshake), <code>21118/tcp</code> (WebSocket).</li>
          </ul>
        </div>
        <div>
          <h3>hbbr (relay)</h3>
          <ul>
            <li>Relais du flux si le P2P direct échoue (NAT strict / firewall).</li>
            <li>Port : <code>21117/tcp</code> (optionnellement UDP selon config).</li>
          </ul>
        </div>
      </div>

      <div class="tip"><strong>Astuce</strong> : montez <em>le même volume</em> sur hbbs et hbbr pour partager la même paire de clés serveur et éviter la « discordance des clés ».</div>

      <h2>Déploiement rapide (Docker sur NAS/VM)</h2>
      <p>Créer un dossier persistant :</p>
<pre><code>mkdir -p /volume1/docker/rustdesk</code></pre>
      <p>Lancer <strong>hbbs</strong> (serveur d’ID) :</p>
<pre><code>docker run -d --name rustdesk-hbbs \&#10;  -p 21115:21115 -p 21116:21116 -p 21116:21116/udp -p 21118:21118 \&#10;  -v /volume1/docker/rustdesk:/root \&#10;  rustdesk/rustdesk-server hbbs</code></pre>
      <p>Récupérer la <strong>clé du serveur</strong> (à copier côté clients, champ <em>Key</em>) :</p>
<pre><code>docker logs --tail=50 rustdesk-hbbs | grep 'Key:'</code></pre>
      <p>Lancer <strong>hbbr</strong> (relay) en partageant le même volume :</p>
<pre><code>docker run -d --name rustdesk-hbbr \&#10;  -p 21117:21117 \&#10;  -v /volume1/docker/rustdesk:/root \&#10;  rustdesk/rustdesk-server hbbr</code></pre>

      <div class="warn"><strong>Redémarrage auto</strong> : <code>docker update --restart unless-stopped rustdesk-hbbs rustdesk-hbbr</code></div>

      <h2>Configuration des clients</h2>
      <ol>
        <li>Ouvrir <em>Paramètres → Réseau → Serveur ID/relais</em>.</li>
        <li>Renseigner :
          <ul>
            <li><strong>Serveur ID</strong> : <code>IP_du_NAS</code></li>
            <li><strong>Serveur relais</strong> : <code>IP_du_NAS</code></li>
            <li><strong>Key</strong> : collez la chaîne base64 vue dans les logs (<code>Key: ...=</code>)</li>
          </ul>
        </li>
        <li><strong>Valider</strong>, puis <strong>redémarrer</strong> RustDesk.</li>
        <li>Sur la machine à contrôler : activer <em>Accès sans surveillance</em> et définir un mot de passe.</li>
      </ol>

      <h2>Accès depuis Internet (facultatif)</h2>
      <p>Rediriger dans votre routeur vers le NAS : <code>21115/tcp</code>, <code>21116/tcp+udp</code>, <code>21117/tcp</code>. Utiliser un DDNS (ex : <code>xxx.synology.me</code>). Limiter l’exposition (filtrage IP, pare‑feu).</p>

      <h2>Sécurité & bonnes pratiques</h2>
      <ul>
        <li>Conserver/backup des fichiers <code>/volume1/docker/rustdesk/id_ed25519*</code>.</li>
        <li>Un même volume pour hbbs/hbbr → même clé → pas de « discordance des clés ».</li>
        <li>Mots de passe forts pour l’accès sans surveillance et MFA système quand possible.</li>
        <li>Pare‑feu Synology/iptables : n’ouvrir que les ports nécessaires.</li>
      </ul>

      <h2>Diagnostic rapide</h2>
      <ul>
        <li><code>docker ps</code> : les deux conteneurs doivent être <em>Up</em>.</li>
        <li><code>docker logs --tail=200 rustdesk-hbbs</code> : recherche des lignes <code>update_pk</code> lors des connexions clients.</li>
        <li><strong>Discordance des clés</strong> : vérifier que la <em>Key</em> collée côté client correspond exactement à celle des logs ; supprimer tout ancien fichier <code>id_ed25519.pub</code> local.</li>
      </ul>

      <h2>Cheat‑sheet</h2>
      <pre><code># Voir la clé serveur
docker logs rustdesk-hbbs | grep 'Key:'

# Redémarrer les services
docker restart rustdesk-hbbs rustdesk-hbbr

# Sauvegarder les clés
cp /volume1/docker/rustdesk/id_ed25519* /volume1/backup/rustdesk/

# Nettoyage complet (avec prudence)
docker stop rustdesk-hbbs rustdesk-hbbr && docker rm rustdesk-hbbs rustdesk-hbbr
rm -rf /volume1/docker/rustdesk/*
</code></pre>

      <p class="tip">Édition communautaire open‑source : gratuite et suffisante pour un usage perso/PME. Une édition Pro ajoute des fonctions d’admin centralisée (optionnelle).</p>

      <p><a href="../blog.html">← Retour au blog</a></p>
    </article>
  </main>
</body>
</html>
